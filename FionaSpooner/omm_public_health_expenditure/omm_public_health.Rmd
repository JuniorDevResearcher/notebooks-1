---
title: "OMM Public Health Expenditure"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(dplyr)
library(ggplot2)
library(janitor)
library(tidyr)
library(zoo)

```

Downloading the data from WHO-GHO and OECD Stat

```{r download}
download.file('https://stats.oecd.org/sdmx-json/data/DP_LIVE/.HEALTHEXP.../OECD?contentType=csv&detail=code&separator=comma&csv-lang=en', 'data/oecd_stat.csv' )
download.file('https://ghoapi.azureedge.net/api/GHED_GGHE-DGDP_SHA2011', 'data/GHED_GGHE-DGDP_SHA2011.json')

```

Loading the data from WHO, OECD Stat, OECD 93 and Lindert

WHO data - Domestic general government health expenditure (GGHE-D) as percentage of gross domestic product (GDP) (%) 'https://ghoapi.azureedge.net/api/GHED_GGHE-DGDP_SHA2011'

OECD Stat - Government Compulsory Schemes 'https://stats.oecd.org/Index.aspx?DataSetCode=SHA_FS#'

```{r }
who <- fromJSON('data/GHED_GGHE-DGDP_SHA2011.json')
who <- who$value
who <- who %>% filter(SpatialDimType == 'COUNTRY') %>% select(entity = SpatialDim, year = TimeDim,value =  NumericValue) %>% mutate(source = 'who_gho')


oecd <- read.csv("data/oecd_stat.csv") %>% filter(SUBJECT == 'COMPULSORY' & MEASURE == 'PC_GDP') %>% select(entity = LOCATION, year = TIME,value = Value ) %>% mutate(source = 'oecd_stat')

oecd_93 <- read.csv("data/OECD 1993.csv") %>% pivot_longer(starts_with('X')) %>% mutate(entity = year, year = as.numeric(gsub("X","",name)), source = 'oecd_93') %>% select(entity,year, value, source )

lindert <- read.csv("data/lindert_1880_1930.csv") %>% select(entity,year, value = public_expenditure_on_health)

countries <- read.csv("data/country_names_country_standardized.csv") %>% distinct()

```

```{r}

oecd_who <- rbind(who, oecd, oecd_93)

oecd_who_df<- oecd_who %>% 
  left_join(., countries, by = c('entity'= 'Country')) %>% 
  select(entity = Our.World.In.Data.Name, year, value, source)

full_lines = oecd_who_df$entity[which(oecd_who_df$year == 1960 & !is.na(oecd_who_df$value))]

ggplot()+
  geom_line(data =oecd_who_df %>% filter(complete.cases(.)& entity %in% full_lines), aes(x = year, y = value, group = interaction(source,entity), colour = source), size = 1)+
  facet_wrap(.~ entity)+
  ggtitle( "WHO - Domestic general government health expenditure (%GDP), OECD Stat - Government (%GDP)")


```

Calculating the rate of change in the OECD Stat data
```{r}
oecd_roc <- oecd %>% 
  select(entity, year, value) %>% 
  group_by(entity) %>% 
  mutate(time_m1 = lag(value, n = 1L), br_roc = time_m1/value, source = 'oecd_stat') %>% 
  select(entity, year = year, br_roc, source) %>% 
  ungroup() %>% 
  filter(complete.cases(.))

summary(oecd_roc)

```

Calculating the rate of change in the OECD 93 data

```{r}
oecd_93_roc <- oecd_93 %>% 
  select(entity, year, value) %>% 
  #filter(between(year, 1960, 1970)) %>% 
  group_by(entity) %>% 
  mutate(time_m1 = lag(value, n = 1L), br_roc = time_m1/value, source = 'oecd_93') %>% 
  select(entity, year, br_roc, source) %>% 
  ungroup() %>% 
  filter(complete.cases(.))

summary(oecd_93_roc)
```

Combine the two rates of change - if there are duplicates for years we have a preference for OECD Stat
```{r}
roc_df <- rbind(oecd_93_roc, oecd_roc)

roc_df <- roc_df %>% 
  left_join(., countries, by = c('entity'= 'Country')) %>% 
  select(entity = Our.World.In.Data.Name, year, br_roc, source)

summary(roc_df)

roc_df <- roc_df %>% 
  group_by(entity, year) %>% 
  add_count() %>%
  ungroup() 


roc_sel <- roc_df[-which(roc_df$n >1 & roc_df$source == 'oecd_93'),]


```
The value for Belgium 1992 is missing - I'll use an average of 1991 and 1993
```{r}

bel_1992 <- roc_sel %>% filter(entity == 'Belgium' & year %in% c(1991,1993)) %>% 
  summarise(entity = 'Belgium',year = 1992, br_roc = mean(br_roc), source = 'OWID', n = 1)

roc_sel <- rbind(roc_sel, bel_1992)

```

The values for Switzerland 1992-95 is missing - I've linearly interpolated between 1991-96

```{r}

swi_90s <- roc_sel %>% 
  filter(entity == 'Switzerland' & year >= 1991 & year <=1996) %>% 
  complete(year = full_seq(1991:1996, 1)) %>% 
  mutate(entity = 'Switzerland',br_roc = na.approx(br_roc), source = 'OWID', n = 1)

roc_sel <- rbind(roc_sel, swi_90s)
```

Standardising the WHO entities

```{r}
who_df <- who %>% 
  left_join(., countries, by = c('entity'= 'Country')) %>% 
  select(entity = Our.World.In.Data.Name, year, value, source)

```

Applying the backwards regression to the WHO data, from 2000 -> 1960


```{r}
years <- 2000:1960 
who_out <- who_df%>% 
  select(entity, year, value)
for (year_sel in years){
  
  roc_yr <- roc_sel %>% filter(year == year_sel)
  
  who_new <- who_out %>% filter(year == year_sel) %>% 
    left_join(., roc_yr, by = 'entity') %>% 
    mutate(value= value*br_roc, year = year_sel-1) %>% 
    select(entity, year, value)
  
  who_out <- rbind(who_out, who_new)
  
}

```

Combining with Lindert data
```{r}
full_owid <- rbind(who_out, lindert)
full_owid <- full_owid %>% select(entity, year, public_health_expenditure_pc_gdp = value) %>% filter(complete.cases(.))


```

Plot data for countries with data over multiple datasets

```{r}
full_lines = full_owid$entity[which(full_owid$year == 1960 & !is.na(full_owid$public_health_expenditure_pc_gdp))]


ggplot()+
  geom_line(data = full_owid %>% filter(entity %in% full_lines), aes(x = year, y = public_health_expenditure_pc_gdp, group = entity, colour = entity))
  
```

Write out the data.
```{r}
write.csv(full_owid, "data/OMM_public_health_expenditure_pc_gdp_new.csv", row.names = FALSE)
```
