---
title: "Format Michalis' output for explorer"
author: "Joe Hasell"
date: "21/04/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(RCurl)
```


```{r}
df <- read.csv("https://raw.githubusercontent.com/owid/notebooks/main/MichalisMoatsos/MainDataCountriesOnly.csv", row.names = 1, header = T, sep = ";", dec = ",")

```

Map 3-letter codes to country names
```{r}
name_mapping <- read.csv("entity_names_three_letter_country_standardized.csv") %>%
  rename(Entity = Country)

df<- left_join(df,name_mapping)

df<- df %>%
  select(-Entity) %>%
  rename(Entity = Our.World.In.Data.Name) %>%
  select(Entity, everything())

```

Rename coumns to work with explorers
```{r}
names(df) <- gsub("[.]", "_", names(df))

```
## Controls and data for poverty explorer
```{r}
poverty_metrics<- data.frame(metric_dropdown = c("Share in poverty",
                            "Number of people in poverty",
                            "Average shortfall to poverty line, per day",
                            "Average shortfall to poverty line, per year",
                            "Total shortfall to poverty line, per day",
                            "Total shortfall to poverty line, per year",
                            "Income gap ratio",
                            "Poverty gap index"),
                     metric_slug_snippet = c("share_of_population_below_poverty_line",
                                               "total_number_of_people_below_poverty_line",
                                             "absolute_poverty_gap_per_day",
                                             "absolute_poverty_gap",
                                             "total_shortfall_per_day",
                                             "total_shortfall_per_year",
                                             "income_gap_ratio",
                                             "poverty_gap_index"))
```

Absolute poverty controls

```{r}


pov_lines<- data.frame(rough_pov_line =  c("1_9",
                    "3_2",
                    "5_5",
                    "10",
                    "15",
                    "20",
                    "30",
                    "40"),
                          clean_pov_line = c( "$1.90 a day",
                    "$3.20 a day",
                    "$5.50 a day",
                    "$10 a day",
                    "$15 a day",
                    "$20 a day",
                    "$30 a day",
                    "$40 a day"))



poverty_metrics<- poverty_metrics %>%
  mutate(title_snippet = c("Poverty: Share of population living on less than",
                           "Poverty: Number of people living on less than",
                            "Depth of poverty: Average daily shortfall to",
                            "Depth of poverty: Average annual shortfall to",
                            "Total daily shortfall to a poverty line of",
                            "Total annual shortfall to a poverty line of",
                            "Depth of poverty: Income gap ratio at",
                            "Poverty gap index at"))



abs_pov_controls<- expand.grid("metric_dropdown" = poverty_metrics$metric_dropdown,
                               "rough_pov_line" = pov_lines$rough_pov_line) 

abs_pov_controls <- left_join(abs_pov_controls, pov_lines) %>%
  rename(pov_line_dropdown = clean_pov_line)

abs_pov_controls <- left_join(abs_pov_controls, poverty_metrics) %>%
  mutate(ySlugs = paste0("X_", rough_pov_line, "_per_day___", metric_slug_snippet),
         title = paste0(title_snippet, " ", pov_line_dropdown))


```

Relative poverty headcount controls
```{r}


pov_lines<- data.frame(rough_pov_line =  c("X_40__of_median_income",
                    "X_50__of_median_income",
                    "X_60__of_median_income"),
                          clean_pov_line = c("40% of median",
                    "50% of median",
                    "60% of median"))


poverty_metrics<- poverty_metrics %>%
  mutate(title_snippet = c("Relative poverty: Share of population living on less than",
                           "Relative poverty: Number of people living on less than",
                           "Depth of relative poverty: Average daily shortfall to",
                           "Depth of relative poverty: Average annual shortfall to",
                           "Total daily shortfall to a poverty line of",
                           "Total annual shortfall to a poverty line of",
                           "Depth of relative poverty: Income gap ratio at",
                           "Poverty gap index at"))



rel_pov_controls<- expand.grid("metric_dropdown" = poverty_metrics$metric_dropdown,
                               "rough_pov_line" = pov_lines$rough_pov_line) 

rel_pov_controls <- left_join(rel_pov_controls, pov_lines) %>%
  mutate(pov_line_dropdown = paste0("Relative line: ", clean_pov_line))

rel_pov_controls <- left_join(rel_pov_controls, poverty_metrics) %>%
  mutate(ySlugs = paste0(rough_pov_line, "___", metric_slug_snippet),
         title = paste0(title_snippet, " ", clean_pov_line))


```

Join controls for the different headcount controls
```{r}
poverty_controls<- bind_rows(abs_pov_controls, rel_pov_controls) %>%
  select(title, metric_dropdown, pov_line_dropdown, ySlugs)

```


Function to repeat controls for each survey data type
```{r}


repeat_controls_by_survey_type<- function(controls_df){

controls_by_survey_type<- list()


controls_by_survey_type[["controls_inc_only"]]<- controls_df %>%
  mutate(survey_type_dropdown = "Income only",
         extrapolate_checkbox = "'true",
         tableSlug = "inc")

controls_by_survey_type[["controls_inc_only_no_extrap"]]<- controls_df %>%
  mutate(survey_type_dropdown = "Income only",
         extrapolate_checkbox = "'false",
         tableSlug = "inc_no_extrap")



controls_by_survey_type[["controls_cons_only"]]<- controls_df %>%
  mutate(survey_type_dropdown = "Consumption only",
         extrapolate_checkbox = "'true",
         tableSlug = "cons")


controls_by_survey_type[["controls_cons_only_no_extrap"]]<- controls_df %>%
  mutate(survey_type_dropdown = "Consumption only",
         extrapolate_checkbox = "'false",
         tableSlug = "cons_no_extrap")


controls_by_survey_type[["controls_inc_and_cons"]]<- controls_df %>%
  mutate(survey_type_dropdown = "Either income or consumption",
         extrapolate_checkbox = "'true",
         tableSlug = "inc_or_cons")


controls_by_survey_type[["controls_inc_and_cons_no_extrap"]]<- controls_df %>%
  mutate(survey_type_dropdown = "Either income or consumption",
         extrapolate_checkbox = "'false",
         tableSlug = "inc_or_cons_no_extrap")


}

```

Repeat controls for poverty
```{r}
poverty_controls_by_survey_type<- repeat_controls_by_survey_type(poverty_controls)
```

Adjust titles in the case of poverty
```{r}



# controls_inc_only<- controls %>%
#   mutate(title = gsub("of median", "of median income", title),
#         
# 
# 
# controls_cons_only<- controls %>%
#   mutate(title = gsub("of median", "of median consumption", title),
#      
# 
# controls_inc_and_cons_no_extrap<- controls %>%
#   mutate(title = gsub("of median", "of median income or consumption", title),
#       
# 
# 
# controls_inc_and_cons_plus_extrap<- controls %>%
#   mutate(title = gsub("of median", "of median income or consumption", title),
# 
#          ....


```


Join survey type controls together
```{r}
poverty_controls_all_survey_types<- bind_rows(poverty_controls_by_survey_type)

poverty_controls_all_survey_types<- poverty_controls_all_survey_types %>%
  select(title, 
         metric_dropdown, 
         pov_line_dropdown, 
         survey_type_dropdown, 
         extrapolate_checkbox, 
         tableSlug, 
         ySlugs)

poverty_controls_all_survey_types<- poverty_controls_all_survey_types %>%
  mutate(yAxisMin = 0)

names(poverty_controls_all_survey_types)<- c("title",
                              "Metric Dropdown", 
                              "Poverty line Dropdown", 
                              "Household survey data type Radio", 
                              "Show extrapolated estimates for years with no survey data Checkbox", 
                              "tableSlug", 
                              "ySlugs",
                              "yAxisMin")


```




## Controls for Across the distribution explorer
```{r}

```


## Controls for Inequality explorer
```{r}


metric_dropdown_non_pov<- c("Mean income or consumption per day",
                            "Median income or consumption per day",
                            "P10: the income or consumption marking the poorest tenth",
                            "P90: the income or consumption marking the richest tenth",
                            "P90:P10 ratio",
                            "Gini coefficient")

```





Write poverty explorer controls to csv
```{r}
write.csv(poverty_controls_all_survey_types, "poverty_explorer_controls.csv", row.names = F)
```


Split dfs by survey type

```{r}

# Income only, including extrapolated years
inc<- df %>%
  filter(datatype == "income")

write.csv(inc, "data/inc.csv", row.names = FALSE)

# Income only, excluding extrapolated years
inc_no_extrap<- df %>%
  filter(IsSurveyYear == TRUE,
         datatype == "income")

write.csv(inc_no_extrap, "data/inc_no_extrap.csv", row.names = FALSE)

  
# Consumption only, including extrapolated years
cons<- df %>%
  filter(datatype == "consumption")

write.csv(cons, "data/cons.csv", row.names = FALSE)

# Consumption only, excluding extrapolated years
cons_no_extrap<- df %>%
  filter(IsSurveyYear == TRUE,
         datatype == "consumption")  

write.csv(cons_no_extrap, "data/cons_no_extrap.csv", row.names = FALSE)


# Both income and consumption, including extrapolated years
write.csv(df, "data/inc_and_cons.csv", row.names = FALSE)


# Both income and consumption, excluding extrapolated years
inc_and_cons_no_extrap<- df %>%
  filter(IsSurveyYear == TRUE)

write.csv(inc_and_cons_no_extrap, "data/inc_and_cons_no_extrap.csv", row.names = FALSE)
  




```



